{% extends "layout/nav_bar.html" %}
{% load static %}

{% block title %}Weather Dashboard - {{ lieu }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 p-6">
  <div class="max-w-6xl mx-auto space-y-10">

    <!-- Title -->
    <div class="text-center">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">
        Weather Dashboard: {{ lieu|title }}
      </h1>
      <p class="text-gray-500">
        Starting from {{ jour }}
      </p>
    </div>
    <div>
         <a href="{% url 'download_pdf' %}" 
   class="bg-[#409ac7] text-white px-4 py-2 rounded-md">
   Download PDF
</a>
    </div>
    {% if error %}
    <div class="bg-red-100 text-red-700 p-4 rounded-lg text-center">
      {{ error }}
    </div>
    {% else %}

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="bg-white p-5 rounded-2xl shadow text-center">
        <h2 class="text-lg font-semibold text-gray-700">Average Temperature</h2>
        <p class="text-3xl font-bold text-red-500 mt-2">{{ temp_moy }}°C</p>
      </div>

      <div class="bg-white p-5 rounded-2xl shadow text-center">
        <h2 class="text-lg font-semibold text-gray-700">Average Humidity</h2>
        <p class="text-3xl font-bold text-blue-500 mt-2">{{ humid_moy }}%</p>
      </div>

      <div class="bg-white p-5 rounded-2xl shadow text-center">
        <h2 class="text-lg font-semibold text-gray-700">Average Wind Speed</h2>
        <p class="text-3xl font-bold text-green-500 mt-2">{{ vent_moy }} km/h</p>
      </div>

      <div class="bg-white p-5 rounded-2xl shadow text-center">
        <h2 class="text-lg font-semibold text-gray-700">Average Precipitation</h2>
        <p class="text-3xl font-bold text-indigo-500 mt-2">{{ precip_moy }} mm</p>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-10">
      <div class="bg-white p-6 rounded-2xl shadow">
        <h3 class="text-center font-semibold text-gray-700 mb-4">Temperature Trend</h3>
        <canvas id="temperatureChart"></canvas>
        <p id="descTemp" class="text-gray-600 text-sm mt-4 text-center italic"></p>
      </div>

      <div class="bg-white p-6 rounded-2xl shadow">
        <h3 class="text-center font-semibold text-gray-700 mb-4">Humidity Trend</h3>
        <canvas id="humidityChart"></canvas>
        <p id="descHumid" class="text-gray-600 text-sm mt-4 text-center italic"></p>
      </div>

      <div class="bg-white p-6 rounded-2xl shadow">
        <h3 class="text-center font-semibold text-gray-700 mb-4">Wind Speed Trend</h3>
        <canvas id="windChart"></canvas>
        <p id="descVent" class="text-gray-600 text-sm mt-4 text-center italic"></p>
      </div>

      <div class="bg-white p-6 rounded-2xl shadow">
        <h3 class="text-center font-semibold text-gray-700 mb-4">Precipitation Trend</h3>
        <canvas id="precipitationChart"></canvas>
        <p id="descPrecip" class="text-gray-600 text-sm mt-4 text-center italic"></p>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const days = {{ dates|safe }};
  const tempMax = {{ temp_max|safe }};
  const tempMin = {{ temp_min|safe }};
  const humid = {{ humid|safe }};
  const vent = {{ vent|safe }};
  const precip = {{ precip|safe }};

  // Generic chart creation function
  function createChart(id, label, data, borderColor, bgColor) {
    new Chart(document.getElementById(id), {
      type: "line",
      data: {
        labels: days,
        datasets: [{
          label: label,
          data: data,
          borderColor: borderColor,
          backgroundColor: bgColor,
          tension: 0.4,
          fill: true,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: "#6b7280" } },
          y: { ticks: { color: "#6b7280" } }
        }
      }
    });
  }

  createChart("temperatureChart", "Temperature (°C)", tempMax, "#ef4444", "rgba(239,68,68,0.2)");
  createChart("humidityChart", "Humidity (%)", humid, "#3b82f6", "rgba(59,130,246,0.2)");
  createChart("windChart", "Wind Speed (km/h)", vent, "#10b981", "rgba(16,185,129,0.2)");
  createChart("precipitationChart", "Precipitation (mm)", precip, "#6366f1", "rgba(99,102,241,0.2)");
</script>

<script>
  // Simple trend analysis function
  function describeTrend(data, variable) {
    const first = data[0];
    const last = data[data.length - 1];
    const diff = last - first;

    if (Math.abs(diff) < 0.5) {
      return `${variable} remains relatively stable over the observed period.`;
    } else if (diff > 0) {
      return `${variable} shows an increasing trend over the period, indicating a possible rise in this parameter.`;
    } else {
      return `${variable} shows a decreasing trend over the period, suggesting a gradual decline.`;
    }
  }

  // Add descriptions under each chart
  document.getElementById("descTemp").innerText = describeTrend(tempMax, "Temperature");
  document.getElementById("descHumid").innerText = describeTrend(humid, "Humidity");
  document.getElementById("descVent").innerText = describeTrend(vent, "Wind speed");
  document.getElementById("descPrecip").innerText = describeTrend(precip, "Precipitation");
</script>

{% endblock %}
